#include <iostream>
#include <filesystem>
#include <fstream>
#include <string>
#include <curl/curl.h>

namespace fs = std::filesystem;

bool sendFileToServer(const std::string& filePath, const std::string& serverUrl) {
    CURL *curl;
    CURLcode res;
    curl_global_init(CURL_GLOBAL_ALL);
    curl = curl_easy_init();

    if(curl) {
        curl_mime *form = curl_mime_init(curl);
        curl_mimepart *field = curl_mime_addpart(form);
        curl_mime_name(field, "file");
        curl_mime_filedata(field, filePath.c_str());

        curl_easy_setopt(curl, CURLOPT_URL, serverUrl.c_str());
        curl_easy_setopt(curl, CURLOPT_MIMEPOST, form);

        res = curl_easy_perform(curl);
        curl_mime_free(form);
        curl_easy_cleanup(curl);
        curl_global_cleanup();

        if(res != CURLE_OK) {
            std::cerr << "Upload failed for " << filePath << ": " << curl_easy_strerror(res) << std::endl;
            return false;
        } else {
            std::cout << "File sent: " << filePath << std::endl;
            return true;
        }
    }
    return false;
}

int main() {
    std::string sourceDir, serverUrl;
    std::cout << "Enter source directory path: ";
    std::cin >> sourceDir;
    std::cout << "Enter server URL (e.g. http://127.0.0.1:4000/upload): ";
    std::cin >> serverUrl;

    try {
        for(const auto& entry : fs::directory_iterator(sourceDir)) {
            if(fs::is_regular_file(entry.path())) {
                sendFileToServer(entry.path().string(), serverUrl);
            }
        }
    } catch(const std::exception& e) {
        std::cerr << "Error accessing files: " << e.what() << std::endl;
    }

    return 0;
}
